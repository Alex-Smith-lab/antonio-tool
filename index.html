<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Antana Labeler</title>

<style>
body{
    margin:0;
    font-family:Arial, sans-serif;
    background:#111;
    color:white;
    display:flex;
    height:100vh;
    overflow:hidden;
}

#main{
    flex:4;
    display:flex;
    flex-direction:column;
    padding:10px;
}

#toolbar{
    padding:10px;
}

#workspace{
    flex:1;
    background:#000;
    border:2px solid #333;
    cursor:crosshair;
    position:relative;
}

canvas{
    background:#000;
    display:block;
}

#sidebar{
    flex:1;
    background:#1e1e1e;
    padding:15px;
    overflow-y:auto;
    border-left:2px solid #333;
}

button{
    margin:5px;
    padding:8px 12px;
    border:none;
    cursor:pointer;
    border-radius:4px;
}

.green{background:#28a745;color:white;}
.red{background:#dc3545;color:white;}
.gray{background:#6c757d;color:white;}
.blue{background:#007bff;color:white;}

.annotation-item{
    background:#2c2c2c;
    padding:8px;
    margin-bottom:5px;
    border-radius:4px;
    font-size:12px;
}

/* Popup */
#labelPopup{
    position:fixed;
    background:#222;
    padding:15px;
    border:2px solid #555;
    display:none;
    z-index:1000;
}

select{
    padding:5px;
    margin-top:10px;
}
</style>
</head>

<body>

<div id="main">

<div id="toolbar">
<h2>Antana Labeler</h2>
<input type="file" id="imageLoader" accept="image/*">
<button class="green" onclick="enableDraw()">Add Box</button>
<button class="red" onclick="deleteSelected()">Delete Selected</button>
<button class="gray" onclick="clearAll()">Clear All</button>
<button class="blue" onclick="downloadJSON()">Download JSON</button>
<span style="margin-left:20px;font-size:12px;">
Mouse Wheel = Zoom | Hold SPACE + Drag = Move
</span>
</div>

<div id="workspace">
<canvas id="canvas"></canvas>
</div>

</div>

<div id="sidebar">
<h3>Annotations</h3>
<div id="annotationList"></div>
</div>

<div id="labelPopup">
<label>Select Label:</label><br>
<select id="labelSelect">
<option>Car</option>
<option>Bus</option>
<option>Truck</option>
<option>Pedestrian</option>
<option>Train</option>
</select><br><br>
<button onclick="applyLabel()">Apply</button>
</div>

<script>
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const imageLoader=document.getElementById("imageLoader");
const annotationList=document.getElementById("annotationList");
const popup=document.getElementById("labelPopup");
const labelSelect=document.getElementById("labelSelect");

let img=new Image();
let annotations=[];
let selectedIndex=-1;

let scale=1;
let originX=0;
let originY=0;

let drawing=false;
let drawMode=false;
let startX,startY;

let panning=false;
let panStartX,panStartY;

const labelColors={
"Car":"#ff3b3b",
"Bus":"#00ff99",
"Truck":"#3399ff",
"Pedestrian":"#ffff00",
"Train":"#ff00ff"
};

imageLoader.addEventListener("change",e=>{
const reader=new FileReader();
reader.onload=event=>{
img.onload=()=>{
canvas.width=img.width;
canvas.height=img.height;
redraw();
};
img.src=event.target.result;
};
reader.readAsDataURL(e.target.files[0]);
});

function enableDraw(){
drawMode=true;
}

canvas.addEventListener("wheel",e=>{
e.preventDefault();
const zoom= e.deltaY<0 ? 1.1 : 0.9;
const mouseX=(e.offsetX-originX)/scale;
const mouseY=(e.offsetY-originY)/scale;
scale*=zoom;
originX=e.offsetX-mouseX*scale;
originY=e.offsetY-mouseY*scale;
redraw();
});

document.addEventListener("keydown",e=>{
if(e.code==="Space") panning=true;
});

document.addEventListener("keyup",e=>{
if(e.code==="Space") panning=false;
});

canvas.addEventListener("mousedown",e=>{
if(panning){
panStartX=e.clientX;
panStartY=e.clientY;
return;
}

const pos=getMousePos(e);

if(drawMode){
drawing=true;
startX=pos.x;
startY=pos.y;
}else{
selectedIndex=getBoxAt(pos.x,pos.y);
redraw();
}
});

canvas.addEventListener("mousemove",e=>{
if(panning){
originX+=e.clientX-panStartX;
originY+=e.clientY-panStartY;
panStartX=e.clientX;
panStartY=e.clientY;
redraw();
return;
}

if(!drawing) return;
const pos=getMousePos(e);
redraw();
ctx.strokeStyle="white";
ctx.strokeRect(startX,startY,pos.x-startX,pos.y-startY);
});

canvas.addEventListener("mouseup",e=>{
if(!drawing) return;
const pos=getMousePos(e);
annotations.push({
x:startX,
y:startY,
width:pos.x-startX,
height:pos.y-startY,
label:"Car",
color:labelColors["Car"]
});
drawing=false;
drawMode=false;
redraw();
updateSidebar();
});

canvas.addEventListener("dblclick",e=>{
const pos=getMousePos(e);
selectedIndex=getBoxAt(pos.x,pos.y);
if(selectedIndex!==-1){
popup.style.left=e.clientX+"px";
popup.style.top=e.clientY+"px";
popup.style.display="block";
}
});

document.addEventListener("click",e=>{
if(!popup.contains(e.target) && e.target!==canvas){
popup.style.display="none";
}
});

function applyLabel(){
const label=labelSelect.value;
annotations[selectedIndex].label=label;
annotations[selectedIndex].color=labelColors[label];
popup.style.display="none";
redraw();
updateSidebar();
}

function getMousePos(e){
return{
x:(e.offsetX-originX)/scale,
y:(e.offsetY-originY)/scale
};
}

function redraw(){
ctx.setTransform(scale,0,0,scale,originX,originY);
ctx.clearRect(-originX/scale,-originY/scale,
canvas.width/scale,canvas.height/scale);
ctx.drawImage(img,0,0);

annotations.forEach(box=>{
ctx.strokeStyle=box.color;
ctx.lineWidth=2/scale;
ctx.strokeRect(box.x,box.y,box.width,box.height);
ctx.fillStyle=box.color;
ctx.fillText(box.label,box.x+5,box.y-5);
});
}

function getBoxAt(x,y){
for(let i=annotations.length-1;i>=0;i--){
let b=annotations[i];
if(x>=b.x&&x<=b.x+b.width&&
y>=b.y&&y<=b.y+b.height){
return i;
}
}
return -1;
}

function deleteSelected(){
if(selectedIndex!==-1){
annotations.splice(selectedIndex,1);
selectedIndex=-1;
redraw();
updateSidebar();
}
}

function clearAll(){
annotations=[];
redraw();
updateSidebar();
}

function updateSidebar(){
annotationList.innerHTML="";
annotations.forEach(box=>{
const div=document.createElement("div");
div.className="annotation-item";
div.style.borderLeft="5px solid "+box.color;
div.innerText=`${box.label} | x:${box.x.toFixed(0)}, y:${box.y.toFixed(0)}`;
annotationList.appendChild(div);
});
}

function downloadJSON(){
const dataStr="data:text/json;charset=utf-8,"+
encodeURIComponent(JSON.stringify(annotations,null,2));
const dl=document.createElement("a");
dl.href=dataStr;
dl.download="annotations.json";
dl.click();
}
</script>

</body>
</html>
