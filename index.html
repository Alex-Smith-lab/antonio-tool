<script>
    // Initialize Annotorious
    const anno = Annotorious.init({
        image: 'target-image',
        widgets: [
            { widget: 'COMMENT', editable: true },
            { widget: 'TAG', vocabulary: ['Car', 'Truck', 'Bus', 'Motorcycle', 'Pedestrian'] }
        ]
    });

    // Enable annotations to be editable
    anno.setDrawingEnabled(false); // start disabled

    let drawingActive = false;

    // --- ZOOM ---
    let scale = 1;
    const container = document.getElementById('annotation-container');
    const viewport = document.getElementById('zoom-viewport');

    viewport.addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? -0.1 : 0.1;
        scale = Math.min(Math.max(0.5, scale + delta), 4);
        container.style.transform = `scale(${scale})`;
    }, { passive: false });

    // --- SIDEBAR ---
    const logEl = document.getElementById('activity-log');

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('hidden');
    }

    function addLog(action, user = "Antonio") {
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        const time = new Date().toLocaleTimeString();
        entry.innerHTML = `<strong>${user}</strong> [${time}]: ${action}`;
        logEl.prepend(entry);
    }

    // --- ANNOTATION MODE TOGGLE ---
    function startDrawing() {
        drawingActive = !drawingActive;

        if (drawingActive) {
            anno.setDrawingTool('rect');
            anno.setDrawingEnabled(true);
            document.querySelector('.add-btn').style.background = "#FBBC05";
            addLog("Annotation mode ENABLED.");
        } else {
            anno.setDrawingEnabled(false);
            document.querySelector('.add-btn').style.background = "#34A853";
            addLog("Annotation mode DISABLED.");
        }
    }

    // --- DELETE ---
    function deleteSelected() {
        const selected = anno.getSelected();
        if (selected) {
            anno.removeAnnotation(selected);
            addLog("Removed annotation.");
        }
    }

    // --- EVENTS ---
    anno.on('createAnnotation', (a) => {
        const tags = a.bodies
            .filter(b => b.type === 'TextualBody' && b.purpose === 'tagging')
            .map(b => b.value)
            .join(', ');
        addLog(`Created annotation. Labels: ${tags || 'None'}`);
    });

    anno.on('selectAnnotation', () => {
        addLog("Annotation selected.");
    });

    // --- EXPORT ---
    function exportData() {
        const data = anno.getAnnotations();
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'antonio_labels.json';
        a.click();
        addLog("Exported annotations.");
    }
</script>
