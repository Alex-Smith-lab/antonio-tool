<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Antana Labeler</title>

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #111;
    color: white;
    display: flex;
    height: 100vh;
    overflow: hidden;
}

#main {
    flex: 4;
    display: flex;
    flex-direction: column;
    padding: 10px;
}

#toolbar {
    padding: 10px;
}

#workspace {
    flex: 1;
    overflow: hidden;
    border: 2px solid #333;
    background: #000;
    position: relative;
    cursor: grab;
}

canvas {
    position: absolute;
    background: #000;
}

#sidebar {
    flex: 1;
    background: #1e1e1e;
    padding: 15px;
    overflow-y: auto;
    border-left: 2px solid #333;
}

button {
    margin: 5px;
    padding: 8px 12px;
    border: none;
    cursor: pointer;
    border-radius: 4px;
}

.green { background: #28a745; }
.red { background: #dc3545; }
.blue { background: #007bff; }
.gray { background: #6c757d; }

.annotation-item {
    background: #2c2c2c;
    padding: 8px;
    margin-bottom: 5px;
    border-radius: 4px;
    font-size: 12px;
}

/* Popup */
#labelPopup {
    position: absolute;
    background: #222;
    padding: 10px;
    border: 2px solid #444;
    display: none;
    z-index: 1000;
}
</style>
</head>

<body>

<div id="main">

<div id="toolbar">
    <h2>Antana Labeler</h2>
    <input type="file" id="imageLoader" accept="image/*">
    <button class="green" onclick="enableDraw()">Add Box</button>
    <button class="blue" onclick="zoomIn()">Zoom +</button>
    <button class="blue" onclick="zoomOut()">Zoom -</button>
    <button class="red" onclick="deleteSelected()">Delete Selected</button>
    <button class="gray" onclick="clearAll()">Clear All</button>
    <button class="blue" onclick="downloadJSON()">Download JSON</button>
</div>

<div id="workspace">
    <canvas id="canvas"></canvas>
</div>

</div>

<div id="sidebar">
    <h3>Annotations</h3>
    <div id="annotationList"></div>
</div>

<div id="labelPopup"></div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const workspace = document.getElementById("workspace");
const imageLoader = document.getElementById("imageLoader");
const annotationList = document.getElementById("annotationList");
const labelPopup = document.getElementById("labelPopup");

let img = new Image();
let annotations = [];
let selectedIndex = -1;

let scale = 1;
let offsetX = 0;
let offsetY = 0;

let drawMode = false;
let drawing = false;
let dragging = false;
let resizing = false;
let resizeCorner = null;
let panning = false;

let startX, startY;

const cornerSize = 8;

const labelColors = {
    Car: "#ff3b3b",
    Bus: "#00ff99",
    Truck: "#3399ff",
    Pedestrian: "#ffff00",
    Train: "#ff00ff"
};

imageLoader.addEventListener("change", function(e) {
    const reader = new FileReader();
    reader.onload = function(event) {
        img.onload = function() {
            canvas.width = img.width;
            canvas.height = img.height;
            offsetX = 0;
            offsetY = 0;
            scale = 1;
            redraw();
        }
        img.src = event.target.result;
    }
    reader.readAsDataURL(e.target.files[0]);
});

function enableDraw() {
    drawMode = true;
}

function zoomIn(){ scale *= 1.1; redraw(); }
function zoomOut(){ scale /= 1.1; redraw(); }

canvas.addEventListener("wheel", e=>{
    e.preventDefault();
    if(e.deltaY<0) zoomIn();
    else zoomOut();
});

workspace.addEventListener("mousedown", e=>{
    if(e.button===1){ // middle mouse for pan
        panning=true;
        workspace.style.cursor="grabbing";
        startX=e.clientX;
        startY=e.clientY;
    }
});

workspace.addEventListener("mousemove", e=>{
    if(panning){
        offsetX += e.clientX-startX;
        offsetY += e.clientY-startY;
        startX=e.clientX;
        startY=e.clientY;
        redraw();
    }
});

workspace.addEventListener("mouseup", ()=>{
    panning=false;
    workspace.style.cursor="grab";
});

canvas.addEventListener("mousedown", e=>{
    const {x,y}=getMousePos(e);

    if(drawMode){
        drawing=true;
        startX=x; startY=y;
        return;
    }

    selectedIndex=getBoxAt(x,y);
    if(selectedIndex!==-1){
        const corner=getCorner(x,y,annotations[selectedIndex]);
        if(corner){
            resizing=true;
            resizeCorner=corner;
        }else{
            dragging=true;
            startX=x;
            startY=y;
        }
    }
    redraw();
});

canvas.addEventListener("mousemove", e=>{
    const {x,y}=getMousePos(e);

    if(drawing){
        redraw();
        ctx.strokeStyle="white";
        ctx.strokeRect(startX,startY,x-startX,y-startY);
        return;
    }

    if(dragging && selectedIndex!==-1){
        let box=annotations[selectedIndex];
        box.x+=x-startX;
        box.y+=y-startY;
        startX=x; startY=y;
        redraw();
    }

    if(resizing && selectedIndex!==-1){
        let box=annotations[selectedIndex];
        if(resizeCorner==="br"){
            box.width=x-box.x;
            box.height=y-box.y;
        }
        if(resizeCorner==="tl"){
            box.width+=box.x-x;
            box.height+=box.y-y;
            box.x=x; box.y=y;
        }
        redraw();
    }
});

canvas.addEventListener("mouseup", e=>{
    const {x,y}=getMousePos(e);

    if(drawing){
        annotations.push({
            x:startX,
            y:startY,
            width:x-startX,
            height:y-startY,
            label:"Car",
            color:labelColors["Car"]
        });
        drawing=false;
        drawMode=false;
        redraw();
        updateSidebar();
    }

    dragging=false;
    resizing=false;
});

canvas.addEventListener("dblclick", e=>{
    const {x,y}=getMousePos(e);
    selectedIndex=getBoxAt(x,y);
    if(selectedIndex!==-1){
        showLabelPopup(e.clientX,e.clientY);
    }
});

function showLabelPopup(px,py){
    labelPopup.innerHTML="";
    for(let label in labelColors){
        const btn=document.createElement("div");
        btn.innerText=label;
        btn.style.color=labelColors[label];
        btn.style.cursor="pointer";
        btn.style.margin="5px 0";
        btn.onclick=function(){
            annotations[selectedIndex].label=label;
            annotations[selectedIndex].color=labelColors[label];
            labelPopup.style.display="none";
            redraw();
            updateSidebar();
        };
        labelPopup.appendChild(btn);
    }
    labelPopup.style.left=px+"px";
    labelPopup.style.top=py+"px";
    labelPopup.style.display="block";
}

function getMousePos(e){
    const rect=canvas.getBoundingClientRect();
    return {
        x:(e.clientX-rect.left-offsetX)/scale,
        y:(e.clientY-rect.top-offsetY)/scale
    };
}

function redraw(){
    ctx.setTransform(scale,0,0,scale,offsetX,offsetY);
    ctx.clearRect(-offsetX/scale,-offsetY/scale,canvas.width,canvas.height);
    ctx.drawImage(img,0,0);

    annotations.forEach((box,index)=>{
        ctx.strokeStyle=box.color;
        ctx.lineWidth=2/scale;
        ctx.strokeRect(box.x,box.y,box.width,box.height);

        ctx.fillStyle=box.color;
        ctx.fillText(box.label,box.x+5,box.y-5);

        if(index===selectedIndex){
            drawCorner(box.x,box.y);
            drawCorner(box.x+box.width,box.y+box.height);
        }
    });
}

function drawCorner(x,y){
    ctx.fillStyle="white";
    ctx.fillRect(x-cornerSize/2,y-cornerSize/2,cornerSize,cornerSize);
}

function getCorner(x,y,box){
    if(Math.abs(x-box.x)<cornerSize && Math.abs(y-box.y)<cornerSize) return "tl";
    if(Math.abs(x-(box.x+box.width))<cornerSize &&
       Math.abs(y-(box.y+box.height))<cornerSize) return "br";
    return null;
}

function getBoxAt(x,y){
    for(let i=annotations.length-1;i>=0;i--){
        let b=annotations[i];
        if(x>=b.x && x<=b.x+b.width &&
           y>=b.y && y<=b.y+b.height){
            return i;
        }
    }
    return -1;
}

function deleteSelected(){
    if(selectedIndex!==-1){
        annotations.splice(selectedIndex,1);
        selectedIndex=-1;
        redraw();
        updateSidebar();
    }
}

function clearAll(){
    annotations=[];
    selectedIndex=-1;
    redraw();
    updateSidebar();
}

function updateSidebar(){
    annotationList.innerHTML="";
    annotations.forEach((box)=>{
        const div=document.createElement("div");
        div.className="annotation-item";
        div.style.borderLeft="5px solid "+box.color;
        div.innerText=`${box.label} | x:${box.x.toFixed(0)}, y:${box.y.toFixed(0)}`;
        annotationList.appendChild(div);
    });
}

function downloadJSON(){
    const dataStr="data:text/json;charset=utf-8,"+
        encodeURIComponent(JSON.stringify(annotations,null,2));
    const dl=document.createElement("a");
    dl.href=dataStr;
    dl.download="annotations.json";
    dl.click();
}
</script>

</body>
</html>
