<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antonio Annotation | 3D Tool</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@recogito/annotorious@2.7.2/dist/annotorious.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@recogito/annotorious@2.7.2/dist/annotorious.all.min.js"></script>

    <style>
        /* This section sets the fixed layout: Header top, Toolbar bottom */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden; /* Prevent the main page from scrolling */
            font-family: sans-serif;
            background: #202124;
            color: white;
            display: flex;
            flex-direction: column;
        }

        header {
            background: #1a1a1a;
            width: 100%;
            padding: 10px;
            text-align: center;
            border-bottom: 2px solid #34A853;
            flex-shrink: 0; /* Header won't shrink */
        }

        /* This is the main content area between header and toolbar */
        .main-container {
            display: flex;
            flex-grow: 1; /* Take up all vertical space */
            overflow: hidden; /* Contains the workspace and sidebar */
        }

        /* The workspace where the image is */
        .workspace {
            flex-grow: 1; /* Workspace takes up remaining horizontal space */
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto; /* This area will scroll if image is too big */
            padding: 20px;
        }
        
        #annotation-container {
            position: relative;
            cursor: crosshair;
        }
        
        #target-image {
            display: block;
            max-width: 100%; /* Image won't grow bigger than workspace */
            height: auto;
        }

        /* Side Panel Styling */
        .sidebar {
            width: 300px;
            background: #1a1a1a;
            border-left: 1px solid #333;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease; /* Smooth opening/closing */
        }

        /* Hidden class for sidebar */
        .sidebar.hidden {
            width: 0;
            overflow: hidden;
            border-left: none;
        }

        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-sidebar {
            background: none;
            border: none;
            color: #aaa;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
        }
        .close-sidebar:hover { color: white; }

        .annotation-list {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
        }
        .annotation-item {
            background: #2b2b2b;
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
        }

        /* Toolbar is fixed to the bottom */
        .toolbar {
            padding: 10px;
            background: #1a1a1a;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 10px;
            border-top: 1px solid #333;
            flex-shrink: 0; /* Toolbar won't shrink */
        }

        button.tool-btn {
            padding: 8px 16px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            font-weight: bold;
        }
        .download-btn { background: #4285F4; color: white; }
        .clear-btn { background: #EA4335; color: white; }
    }
    </style>
</head>
<body>

    <header>
        <h1>ANTONIO ANNOTATION</h1>
        <p style="margin: 0; color: #FBBC05;">3D Cuboid Bounding Box Tool</p>
    </header>

    <div class="main-container">
        <div class="workspace">
            <div id="annotation-container">
                <img id="target-image" src="https://raw.githubusercontent.com/Alex-Smith-lab/antonio-tool/main/scene.jpg">
            </div>
        </div>

        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3>Annotations</h3>
                <button class="close-sidebar" onclick="toggleSidebar()">Ã—</button>
            </div>
            <div class="annotation-list" id="annotation-list">
                <div class="annotation-item">Draw a box to see labels</div>
            </div>
        </div>
    </div>

    <div class="toolbar">
        <button class="tool-btn download-btn" onclick="exportData()">Download 3D Data (JSON)</button>
        <button class="tool-btn clear-btn" onclick="resetAll()">Clear All</button>
        <button class="tool-btn" style="background: #555;" onclick="toggleSidebar()">Show/Hide Panel</button>
    </div>

    <script>
        // --- 1. Annotation Tool Setup with Labels ---
        // Initialize the annotation tool with predefined labels
        const anno = Annotorious.init({
            image: 'target-image',
            // Predefined vocabulary for vehicles
            widgets: [
                { widget: 'COMMENT' },
                { widget: 'TAG', vocabulary: [ 'Car', 'Truck', 'Bike', 'Bus' ] }
            ]
        });

        // Event: When an annotation is created, show the popup to choose labels
        anno.on('createAnnotation', function(annotation) {
            // Annotorious automatically shows the popup
            // We'll also update the sidebar list
            updateSidebarList();
        });

        // Event: When an annotation is updated or deleted
        anno.on('updateAnnotation', updateSidebarList);
        anno.on('deleteAnnotation', updateSidebarList);


        // --- 2. Side Panel Logic ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('hidden');
        }

        function updateSidebarList() {
            const listEl = document.getElementById('annotation-list');
            const annotations = anno.getAnnotations();
            
            // Clear current list
            listEl.innerHTML = '';
            
            if (annotations.length === 0) {
                listEl.innerHTML = '<div class="annotation-item">Draw a box to see labels</div>';
                return;
            }

            // Create a list item for each annotation
            annotations.forEach((a, index) => {
                const item = document.createElement('div');
                item.className = 'annotation-item';
                item.innerHTML = `<strong>#${index + 1}:</strong> Box at [${Math.round(a.target.selector.value.split(':')[1].split(',')[0])}, ${Math.round(a.target.selector.value.split(':')[1].split(',')[1])}]`;
                
                // Add tag information if available
                if (a.bodies && a.bodies.some(b => b.type === 'TagBody')) {
                    const tags = a.bodies.filter(b => b.type === 'TagBody').map(b => b.value).join(', ');
                    item.innerHTML += `<br><em>Label:</em> ${tags}`;
                }
                
                listEl.appendChild(item);
            });
        }


        // --- 3. Toolbar and Export Logic ---
        function exportData() {
            // ... (Your existing export JSON logic) ...
        }

        function resetAll() {
            // ... (Your existing clear all logic) ...
        }
    </script>
</body>
</html>
