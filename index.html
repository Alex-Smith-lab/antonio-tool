<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Antonio Pro Annotation Tool</title>

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #111;
    color: white;
    display: flex;
    height: 100vh;
    overflow: hidden;
}

#main {
    flex: 4;
    display: flex;
    flex-direction: column;
    padding: 10px;
}

#toolbar {
    padding: 10px;
}

#workspace {
    flex: 1;
    overflow: auto;
    border: 2px solid #333;
    background: #000;
    display: flex;
    justify-content: center;
    align-items: center;
}

canvas {
    background: #000;
    cursor: crosshair;
}

#sidebar {
    flex: 1;
    background: #1e1e1e;
    padding: 15px;
    overflow-y: auto;
    border-left: 2px solid #333;
}

button {
    margin: 5px;
    padding: 8px 12px;
    border: none;
    cursor: pointer;
    border-radius: 4px;
}

.green { background: #28a745; color: white; }
.red { background: #dc3545; color: white; }
.blue { background: #007bff; color: white; }
.gray { background: #6c757d; color: white; }

.annotation-item {
    background: #2c2c2c;
    padding: 8px;
    margin-bottom: 5px;
    border-radius: 4px;
    font-size: 12px;
}

/* Label Popup */
#labelPopup {
    position: fixed;
    background: #222;
    padding: 10px;
    border: 2px solid #444;
    display: none;
    z-index: 1000;
}

.label-option {
    padding: 5px;
    cursor: pointer;
    margin: 3px 0;
}

.label-option:hover {
    background: #444;
}
</style>
</head>

<body>

<div id="main">

<div id="toolbar">
    <h2>Antonio Pro Annotation Tool</h2>
    <input type="file" id="imageLoader" accept="image/*">
    <button class="green" onclick="enableDraw()">Add Box</button>
    <button class="blue" onclick="zoomIn()">Zoom +</button>
    <button class="blue" onclick="zoomOut()">Zoom -</button>
    <button class="red" onclick="deleteSelected()">Delete Selected</button>
    <button class="gray" onclick="clearAll()">Clear All</button>
    <button class="blue" onclick="downloadJSON()">Download JSON</button>
</div>

<div id="workspace">
    <canvas id="canvas"></canvas>
</div>

</div>

<div id="sidebar">
    <h3>Annotations</h3>
    <div id="annotationList"></div>
</div>

<div id="labelPopup"></div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const imageLoader = document.getElementById("imageLoader");
const annotationList = document.getElementById("annotationList");
const labelPopup = document.getElementById("labelPopup");

let img = new Image();
let annotations = [];
let selectedIndex = -1;

let scale = 1;
let drawMode = false;
let drawing = false;
let startX, startY;

const labelColors = {
    "Car": "#ff3b3b",
    "Bus": "#00ff99",
    "Truck": "#3399ff",
    "Pedestrian": "#ffff00",
    "Train": "#ff00ff"
};

imageLoader.addEventListener("change", function(e) {
    const reader = new FileReader();
    reader.onload = function(event) {
        img.onload = function() {
            canvas.width = img.width;
            canvas.height = img.height;
            redraw();
        }
        img.src = event.target.result;
    }
    reader.readAsDataURL(e.target.files[0]);
});

function enableDraw() {
    drawMode = true;
}

function zoomIn() {
    scale *= 1.2;
    redraw();
}

function zoomOut() {
    scale /= 1.2;
    redraw();
}

canvas.addEventListener("wheel", function(e){
    e.preventDefault();
    if (e.deltaY < 0) zoomIn();
    else zoomOut();
});

canvas.addEventListener("mousedown", function(e) {
    const {x,y} = getMousePos(e);

    if (drawMode) {
        drawing = true;
        startX = x;
        startY = y;
    } else {
        selectedIndex = getBoxAt(x,y);
        redraw();
    }
});

canvas.addEventListener("mousemove", function(e) {
    if (!drawing) return;

    const {x,y} = getMousePos(e);
    redraw();

    ctx.strokeStyle = "white";
    ctx.strokeRect(startX, startY, x-startX, y-startY);
});

canvas.addEventListener("mouseup", function(e) {
    if (!drawing) return;

    const {x,y} = getMousePos(e);

    annotations.push({
        x: startX,
        y: startY,
        width: x-startX,
        height: y-startY,
        label: "Car",
        color: labelColors["Car"]
    });

    drawing = false;
    drawMode = false;
    redraw();
    updateSidebar();
});

canvas.addEventListener("dblclick", function(e){
    const {x,y} = getMousePos(e);
    selectedIndex = getBoxAt(x,y);
    if (selectedIndex !== -1) {
        showLabelPopup(e.clientX, e.clientY);
    }
});

function showLabelPopup(px, py){
    labelPopup.innerHTML = "";
    for (let label in labelColors){
        const div = document.createElement("div");
        div.className = "label-option";
        div.style.color = labelColors[label];
        div.innerText = label;
        div.onclick = function(){
            annotations[selectedIndex].label = label;
            annotations[selectedIndex].color = labelColors[label];
            labelPopup.style.display = "none";
            redraw();
            updateSidebar();
        }
        labelPopup.appendChild(div);
    }
    labelPopup.style.left = px+"px";
    labelPopup.style.top = py+"px";
    labelPopup.style.display = "block";
}

function getMousePos(e){
    const rect = canvas.getBoundingClientRect();
    return {
        x: (e.clientX - rect.left)/scale,
        y: (e.clientY - rect.top)/scale
    };
}

function redraw(){
    ctx.setTransform(scale,0,0,scale,0,0);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img,0,0);

    annotations.forEach((box,index)=>{
        ctx.strokeStyle = box.color;
        ctx.lineWidth = 2/scale;
        ctx.strokeRect(box.x,box.y,box.width,box.height);

        ctx.fillStyle = box.color;
        ctx.fillText(box.label, box.x+5, box.y-5);
    });
}

function getBoxAt(x,y){
    for(let i=annotations.length-1;i>=0;i--){
        let b=annotations[i];
        if(x>=b.x && x<=b.x+b.width &&
           y>=b.y && y<=b.y+b.height){
            return i;
        }
    }
    return -1;
}

function deleteSelected(){
    if(selectedIndex!==-1){
        annotations.splice(selectedIndex,1);
        selectedIndex=-1;
        redraw();
        updateSidebar();
    }
}

function clearAll(){
    annotations=[];
    redraw();
    updateSidebar();
}

function updateSidebar(){
    annotationList.innerHTML="";
    annotations.forEach((box)=>{
        const div=document.createElement("div");
        div.className="annotation-item";
        div.style.borderLeft="5px solid "+box.color;
        div.innerText=`${box.label} | x:${box.x.toFixed(0)}, y:${box.y.toFixed(0)}`;
        annotationList.appendChild(div);
    });
}

function downloadJSON(){
    const dataStr="data:text/json;charset=utf-8,"+
        encodeURIComponent(JSON.stringify(annotations,null,2));
    const dl=document.createElement("a");
    dl.href=dataStr;
    dl.download="annotations.json";
    dl.click();
}
</script>

</body>
</html>
