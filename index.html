<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Antana Labeler - Production</title>

<style>
body{
    margin:0;
    font-family:Arial;
    background:#111;
    color:white;
    display:flex;
    height:100vh;
    overflow:hidden;
}

#leftPanel{
    width:220px;
    background:#181818;
    border-right:2px solid #333;
    overflow-y:auto;
    padding:10px;
}

#main{
    flex:4;
    display:flex;
    flex-direction:column;
}

#toolbar{
    padding:10px;
    background:#1e1e1e;
}

#workspace{
    flex:1;
    background:black;
    position:relative;
    overflow:hidden;
}

canvas{
    display:block;
    background:black;
}

#rightPanel{
    width:250px;
    background:#1e1e1e;
    border-left:2px solid #333;
    padding:10px;
    overflow-y:auto;
}

.imageItem{
    padding:5px;
    cursor:pointer;
    background:#2a2a2a;
    margin-bottom:5px;
}

.imageItem.active{
    background:#007bff;
}

.annotation-item{
    font-size:12px;
    padding:4px;
    margin-bottom:4px;
    background:#2c2c2c;
}

button{
    margin:3px;
    padding:6px 10px;
    border:none;
    border-radius:4px;
    cursor:pointer;
}

.green{background:#28a745;color:white;}
.blue{background:#007bff;color:white;}
.red{background:#dc3545;color:white;}
.gray{background:#6c757d;color:white;}

#labelPopup{
    position:fixed;
    background:#222;
    padding:10px;
    border:2px solid #555;
    display:none;
    z-index:1000;
}
</style>
</head>

<body>

<div id="leftPanel">
<h3>Images</h3>
<input type="file" id="imageLoader" multiple accept="image/*"><br><br>
<div id="imageList"></div>
</div>

<div id="main">
<div id="toolbar">
<h2>Antana Labeler - Production</h2>
<button class="green" onclick="enableDraw()">Add Box</button>
<button class="red" onclick="deleteSelected()">Delete</button>
<button class="gray" onclick="clearCurrent()">Clear Image</button>
<button class="blue" onclick="exportYOLO()">Export YOLO</button>
<button class="blue" onclick="exportCOCO()">Export COCO</button>
<button class="blue" onclick="exportBackup()">Backup JSON</button>
<span style="margin-left:15px;font-size:12px;">
Wheel = Zoom | SPACE + Drag = Pan | C/B/T/P/R = Class
</span>
</div>

<div id="workspace">
<canvas id="canvas"></canvas>
</div>
</div>

<div id="rightPanel">
<h3>Annotations</h3>
<div id="annotationList"></div>
<h3>Class Counter</h3>
<div id="classCounter"></div>
</div>

<div id="labelPopup">
<select id="labelSelect">
<option>Car</option>
<option>Bus</option>
<option>Truck</option>
<option>Pedestrian</option>
<option>Train</option>
</select>
<button onclick="applyLabel()">Apply</button>
</div>

<script>
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");

const imageLoader=document.getElementById("imageLoader");
const imageList=document.getElementById("imageList");
const annotationList=document.getElementById("annotationList");
const classCounter=document.getElementById("classCounter");
const popup=document.getElementById("labelPopup");
const labelSelect=document.getElementById("labelSelect");

let dataset={};
let images=[];
let currentImage=null;
let img=new Image();

let scale=1, originX=0, originY=0;
let drawMode=false, drawing=false;
let startX,startY;
let selectedIndex=-1;
let panning=false, panStartX, panStartY;

const classMap=["Car","Bus","Truck","Pedestrian","Train"];
const labelColors={
Car:"#ff3b3b",
Bus:"#00ff99",
Truck:"#3399ff",
Pedestrian:"#ffff00",
Train:"#ff00ff"
};

imageLoader.addEventListener("change",e=>{
images=[...e.target.files];
imageList.innerHTML="";
images.forEach((file,i)=>{
dataset[file.name]=dataset[file.name]||[];
const div=document.createElement("div");
div.className="imageItem";
div.innerText=file.name;
div.onclick=()=>loadImage(i);
imageList.appendChild(div);
});
});

function loadImage(index){
const file=images[index];
currentImage=file.name;
document.querySelectorAll(".imageItem")
.forEach(el=>el.classList.remove("active"));
imageList.children[index].classList.add("active");

const reader=new FileReader();
reader.onload=e=>{
img.onload=()=>{
canvas.width=img.width;
canvas.height=img.height;
scale=1;originX=0;originY=0;
redraw();
};
img.src=e.target.result;
};
reader.readAsDataURL(file);
}

function enableDraw(){drawMode=true;}

canvas.addEventListener("wheel",e=>{
e.preventDefault();
const zoom=e.deltaY<0?1.1:0.9;
const mx=(e.offsetX-originX)/scale;
const my=(e.offsetY-originY)/scale;
scale*=zoom;
originX=e.offsetX-mx*scale;
originY=e.offsetY-my*scale;
redraw();
});

document.addEventListener("keydown",e=>{
if(e.code==="Space")panning=true;
if(selectedIndex!==-1){
if(e.key==="Delete")deleteSelected();
if(e.key.toUpperCase()==="C")quickLabel("Car");
if(e.key.toUpperCase()==="B")quickLabel("Bus");
if(e.key.toUpperCase()==="T")quickLabel("Truck");
if(e.key.toUpperCase()==="P")quickLabel("Pedestrian");
if(e.key.toUpperCase()==="R")quickLabel("Train");
}
});
document.addEventListener("keyup",e=>{
if(e.code==="Space")panning=false;
});

canvas.addEventListener("mousedown",e=>{
if(panning){
panStartX=e.clientX;
panStartY=e.clientY;
return;
}
const pos=getMouse(e);
if(drawMode){
drawing=true;
startX=pos.x;
startY=pos.y;
}else{
selectedIndex=getBoxAt(pos.x,pos.y);
redraw();
}
});

canvas.addEventListener("mousemove",e=>{
if(panning){
originX+=e.clientX-panStartX;
originY+=e.clientY-panStartY;
panStartX=e.clientX;
panStartY=e.clientY;
redraw();
return;
}
if(!drawing)return;
const pos=getMouse(e);
redraw();
ctx.strokeStyle="white";
ctx.strokeRect(startX,startY,pos.x-startX,pos.y-startY);
});

canvas.addEventListener("mouseup",e=>{
if(!drawing)return;
const pos=getMouse(e);
dataset[currentImage].push({
x:startX,y:startY,
width:pos.x-startX,
height:pos.y-startY,
label:"Car"
});
drawing=false;drawMode=false;
redraw();updateSidebar();
});

canvas.addEventListener("dblclick",e=>{
const pos=getMouse(e);
selectedIndex=getBoxAt(pos.x,pos.y);
if(selectedIndex!==-1){
popup.style.left=e.clientX+"px";
popup.style.top=e.clientY+"px";
popup.style.display="block";
}
});

function applyLabel(){
dataset[currentImage][selectedIndex].label=labelSelect.value;
popup.style.display="none";
redraw();updateSidebar();
}

function quickLabel(label){
dataset[currentImage][selectedIndex].label=label;
redraw();updateSidebar();
}

function getMouse(e){
return{
x:(e.offsetX-originX)/scale,
y:(e.offsetY-originY)/scale
};
}

function redraw(){
ctx.setTransform(scale,0,0,scale,originX,originY);
ctx.clearRect(-originX/scale,-originY/scale,
canvas.width/scale,canvas.height/scale);
ctx.drawImage(img,0,0);
if(!currentImage)return;
dataset[currentImage].forEach((box,i)=>{
ctx.strokeStyle=labelColors[box.label];
ctx.lineWidth=2/scale;
ctx.strokeRect(box.x,box.y,box.width,box.height);
ctx.fillStyle=labelColors[box.label];
ctx.fillText(box.label,box.x+5,box.y-5);
});
}

function getBoxAt(x,y){
if(!currentImage)return -1;
const arr=dataset[currentImage];
for(let i=arr.length-1;i>=0;i--){
let b=arr[i];
if(x>=b.x&&x<=b.x+b.width&&
y>=b.y&&y<=b.y+b.height)return i;
}
return -1;
}

function deleteSelected(){
if(selectedIndex!==-1){
dataset[currentImage].splice(selectedIndex,1);
selectedIndex=-1;
redraw();updateSidebar();
}
}

function clearCurrent(){
dataset[currentImage]=[];
redraw();updateSidebar();
}

function updateSidebar(){
annotationList.innerHTML="";
classCounter.innerHTML="";
let counts={};
if(!currentImage)return;
dataset[currentImage].forEach(box=>{
counts[box.label]=(counts[box.label]||0)+1;
const div=document.createElement("div");
div.className="annotation-item";
div.style.borderLeft="5px solid "+labelColors[box.label];
div.innerText=box.label;
annotationList.appendChild(div);
});
for(let cls in counts){
classCounter.innerHTML+=cls+": "+counts[cls]+"<br>";
}
}

function exportBackup(){
downloadJSON(dataset,"dataset_backup.json");
}

function exportYOLO(){
let output="";
images.forEach(file=>{
let anns=dataset[file.name];
if(!anns)return;
anns.forEach(box=>{
let id=classMap.indexOf(box.label);
let x=(box.x+box.width/2)/img.width;
let y=(box.y+box.height/2)/img.height;
let w=box.width/img.width;
let h=box.height/img.height;
output+=`${file.name}: ${id} ${x.toFixed(4)} ${y.toFixed(4)} ${w.toFixed(4)} ${h.toFixed(4)}\n`;
});
});
downloadJSON(output,"yolo_export.txt");
}

function exportCOCO(){
let coco={images:[],annotations:[],categories:[]};
classMap.forEach((c,i)=>{
coco.categories.push({id:i,name:c});
});
let annId=0;
images.forEach((file,i)=>{
coco.images.push({id:i,file_name:file.name});
dataset[file.name]?.forEach(box=>{
coco.annotations.push({
id:annId++,
image_id:i,
category_id:classMap.indexOf(box.label),
bbox:[box.x,box.y,box.width,box.height],
area:box.width*box.height,
iscrowd:0
});
});
});
downloadJSON(coco,"coco_export.json");
}

function downloadJSON(data,name){
const blob=new Blob([typeof data==="string"?data:JSON.stringify(data,null,2)],
{type:"application/json"});
const a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download=name;
a.click();
}
</script>

</body>
</html>
